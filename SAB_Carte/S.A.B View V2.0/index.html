<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Carte interactive SAB</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<style>
    html,
    body {
        margin: 0;
        padding: 0;
        height: 100%;
    }

    #map {
        width: 100%;
        height: 100%;
    }
</style>

<body>

    <div id="map"></div>
    <script>
        // Init carte
        var map = L.map('map').setView([48.1, -2.9], 7);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // Générateur d'icônes colorées
        function getIcon(color = "blue") {
            return new L.Icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
                shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        // Fonction pour ajouter un marker depuis une adresse
        async function addMarkerByAddress(address, type, radiusKm = 0) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&addressdetails=1`
                );
                const data = await response.json();

                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    const fullAddress = data[0].display_name;

                    const color = type.toLowerCase();
                    const icon = getIcon(color);

                    // Ajout du marker
                    let popupContent = `<b>${address}</b><br><i>Adresse trouvée :</i> ${fullAddress}`;
                    if (radiusKm > 0) {
                        popupContent += `<br>Périmètre ${radiusKm} km`;
                    }

                    L.marker([lat, lon], { icon })
                        .addTo(map)
                        .bindPopup(popupContent);

                    // Ajout du cercle uniquement si perimetre > 0
                    if (radiusKm > 0) {
                        L.circle([lat, lon], {
                            radius: radiusKm * 1000,
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.2
                        }).addTo(map);
                    }

                } else {
                    console.warn(`Aucune donnée trouvée pour "${address}"`);
                }
            } catch (error) {
                console.error(`Erreur fetch pour "${address}"`, error);
            }
        }

        // Lecture du CSV avec PapaParse
        Papa.parse("donnees.csv", {
            download: true,
            header: true,
            complete: function (results) {
                const rows = results.data;

                rows.forEach((row, index) => {
                    setTimeout(() => {
                        const type = row.Type?.toLowerCase();
                        const adresse = row.Adresse;
                        const perimetre = parseFloat(row.PerimetreKm) || 0; // 0 = pas de cercle

                        if (!adresse || !type) {
                            console.warn("Ligne incomplète ignorée :", row);
                            return;
                        }

                        addMarkerByAddress(adresse, type, perimetre);
                    }, index * 1100); // tempo entre les requêtes
                });
            }
        });
    </script>
</body>

</html>
